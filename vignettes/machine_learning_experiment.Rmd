
---
title: "Risk Factors Associated with Suicide Attempts in U.S High School Students using Machine Learning Tools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Risk Factors Associated with Suicide Attempts in U.S High School Students using Machine Learning Tools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = TRUE,
	warning = TRUE
)
```

```{r tidyverse, include=FALSE, message=FALSE}
library(conflicted)
conflict_prefer("filter", "dplyr", quiet = TRUE)
conflict_prefer("lag", "dplyr", quiet = TRUE)
suppressPackageStartupMessages(library(tidyverse))

# suppress "`summarise()` has grouped output by " messages
options(dplyr.summarise.inform=F)  
```

```{r tidymodels, include=FALSE}
suppressPackageStartupMessages(library(tidymodels))
tidymodels_prefer()
suppressMessages(conflict_prefer("spec", "yardstick"))
```

```{r setup-packages, include=FALSE}
library(tidyYRBS)
library(srvyr)
library(survey)
library(janitor)
library(gtsummary)

```

```{r loading-data, include=FALSE}
data("data_yrbs_2019")
```

# Background

Suicide ideation among youth are a major public health concern in the U.S.. Between 2009 and 2019, there was a significant increase in the prevalence of adolescents suidice ideation (Jones et al., 2022). Using data from the 2019 Youth Risk Behavioral Surveillance System (YRBSS) this study aims to generate a decision tree based on CART to detect risk factors for suicide attempt

# Method
The data comes from the biennial YRBSS for high school students from 2019. The `tidyYRBS` package was used to analyze the data in R studio and perform the wrangling. 

```{r demographics, include=FALSE}
n <- 
  data_yrbs_2019 %>% 
  nrow()

table(data_yrbs_2019$suicide_considered)
table(data_yrbs_2019$Sex)
table1::table1(~ Sex + suicide_considered + suicide_attempts + suicide_planned + suicide_injury, data = data_yrbs_2019)

```

The number of adolescents included in this study is N = `r format(c(n), big.mark = ",")`. 


```{r weights, include=FALSE}

# This function transforms the Data Frame into a survey object
yrbs_2019_srv <-
  data_yrbs_2019 %>%
  srvyr::as_survey_design(
    ids     = psu,
    weights = weight,
    strata  = stratum,
    nest    = TRUE
  )

# Cheking the amount of observations

total_weight <- 
  yrbs_2019_srv  %>% 
  summarise(N = survey_total())


# Checking the data to compare with the official results. 
# There are differences, but it looks like the result is not taking into account the 
# weights, at least for sex

# https://www.cdc.gov/healthyyouth/data/yrbs/pdf/2019/su6901-H.pdf

by_sex <- 
  yrbs_2019_srv %>% 
  group_by(Sex) %>%
  summarise(N = survey_total())

# Total people: 6690.2341(F) + 6861.9249(M) + 124.8481 (NA) = 13677 total
# By sex there are differences in the amount 

suicide_considered <- 
  yrbs_2019_srv %>% 
  group_by(suicide_considered) %>%
  summarise(proportion = survey_mean(),
            total = survey_total())
# True: 2527.3820 (18.4%) | False: 10950.3745 (80.06%) | NA: 199 (1.4%) 

suicide_attempt <- 
  yrbs_2019_srv %>% 
  group_by(suicide_attempts) %>%
  summarise(proportion = survey_mean(),
            total = survey_total())
# True: 1017.866 (7.4%) | False: 10411.594 (76.12%) | NA: 2247 (16%) 

suicide_planned <- 
  yrbs_2019_srv %>% 
  group_by(suicide_planned) %>%
  summarise(proportion = survey_mean(),
            total = survey_total())
# True: 2117.3515 (15.5%) | False: 11360.0414 (83.05%) | NA: 199.6142 (1%) 

suicide_injury <- 
  yrbs_2019_srv %>% 
  group_by(suicide_injury) %>%
  summarise(proportion = survey_mean(),
            total = survey_total())
# True: 268.2899 (1.9%) | False: 10359.5872	 (75.57%) | NA: 3049.1300 (2.2%) 
```


## CART without weights 

```{r}
glimpse(data_yrbs_2019)
```


This code will split the data into testing and training

```{r split-data}

data_yrbs_2019_race <- 
  data_yrbs_2019 %>% 
  filter(Race == "Hispanic/Latino") %>% 
  mutate(
    across(
      c(suicide_considered, suicide_planned, suicide_injury, Q4, Q19, 
        Q23, Q24, Q25, Q30, Q34, Q57, Q39, Q57, Q63, Q58, Q98, Q84, Q85, Q87, Q94), 
      factor
     )
   ) %>% 
  select(- c(weight, stratum, psu, n_suicide_attempts, Race, Q4))


set.seed(02282015)

analysis_split <-
  data_yrbs_2019_race  %>% 
  initial_split(strata = suicide_considered)

analysis_split

analysis_train <- training(analysis_split)
analysis_test <- testing(analysis_split)

# Checking the training and test data sets

n_analysis_model <- 
data_yrbs_2019 |>
  tabyl(suicide_considered) |>
  adorn_pct_formatting(0) |>
  adorn_totals()

n_analysis_train <- 
analysis_train |>
  tabyl(suicide_considered) |>
  adorn_pct_formatting(0) |>
  adorn_totals()

n_analysis_test <- 
analysis_test |>
  tabyl(suicide_considered) |>
  adorn_pct_formatting(0) |>
  adorn_totals()

# Creating table for report
table_model <- 
  data_yrbs_2019 |> 
  select(suicide_considered) 

tbl_analysis_model <- tbl_summary(table_model)

table_train <- 
  analysis_train |> 
  select(suicide_considered) 

tbl_analysis_train <- tbl_summary(table_train)

table_test <- 
  analysis_test  |> 
  select(suicide_considered)
    
tbl_analysis_test <- tbl_summary(table_test)

complete_table <- 
  tbl_merge(
    tbls = list(tbl_analysis_model, tbl_analysis_train, tbl_analysis_test), 
    tab_spanner = c("**Complete data**", "**Training data**", "**Testing data**" ) 
  ) 

```

## Building the model with `Tidymodels`

```{r themodel}
the_recipe <- 
  recipe(formula = suicide_considered ~ ., data = analysis_train) %>%
  update_role(ID, new_role = "ID") %>%  
  step_dummy(all_nominal_predictors()) 

x <- bake(prep(the_recipe), new_data = NULL)
skimr::skim(x)

cart_model <- 
  decision_tree(cost_complexity = tune()) %>% 
  set_engine("rpart") %>% 
  set_mode("classification")

cart_workflow <- 
  workflow() %>% 
  add_recipe(the_recipe) %>% 
  add_model(cart_model)

cv_folds <-
  vfold_cv(analysis_train, 
           v = 5,  # the number of sets
           strata = suicide_considered)

doParallel::registerDoParallel()  # use multiple CPU cores for faster processing

cart_tune <- 
  cart_workflow %>% 
  tune_grid(resamples = cv_folds,
            grid = 10, 
            metrics = metric_set(roc_auc, kap),
            control = control_grid(save_pred = TRUE)
  )

doParallel::stopImplicitCluster()  

# Best CP
show_best(cart_tune, metric = "roc_auc")

bestPlot_cart <- 
  autoplot(cart_tune)

cart_best <- select_best(cart_tune, metric = "roc_auc")

# The model with the best CP

cart_final_workflow <- 
  cart_workflow %>% 
  finalize_workflow(cart_best)

ideation_fit <- 
  cart_final_workflow |>  
  fit(data = analysis_train)

the_results <-
  cart_final_workflow %>% 
  last_fit(split = analysis_split, 
           metrics = metric_set(recall, precision, f_meas, 
                                yardstick::accuracy, kap,
                                roc_auc, sens, spec))

# Metrics
the_results %>%
  collect_metrics(summarize = TRUE)

# Prediction per person 

the_prediction <-  
  the_results %>% 
  collect_predictions()

head(the_prediction, n = 20)

# Confusion Matrix 

confusion_matrix_cart <- 
  the_prediction %>% 
  conf_mat(suicide_considered, .pred_class)

confusion_matrixPlot_cart <- 
  autoplot(confusion_matrix_cart, type = "heatmap")

#ROC curve training

ideation_pred_train <- 
  predict(ideation_fit, analysis_train, type = "prob") |> 
  bind_cols(analysis_train %>% select(suicide_considered)) 

ideation_pred_train

rocPlot_cart_train <- 
  ideation_pred_train |> 
  roc_curve(truth = suicide_considered, .pred_FALSE) |> 
  autoplot()

rocTable_cart_train <- 
  ideation_pred_train  %>% 
  roc_auc(truth = suicide_considered, .pred_FALSE)

# ROC curve testing

rocPlot_cart <- 
  the_prediction %>% 
  roc_curve(suicide_considered, .pred_FALSE) %>% 
  autoplot() 

rocTable_cart <- 
  the_prediction |> 
  roc_auc(truth = suicide_considered, .pred_FALSE)


# The tree ----------------------------------------------------------------


cart_trained <- 
  the_results |> extract_fit_parsnip()

cart_tree_fit <- cart_trained$fit

rpart.plot::rpart.plot(cart_tree_fit, roundint = FALSE)

treemisc::tree_diagram(cart_tree_fit, roundint=FALSE)

```

